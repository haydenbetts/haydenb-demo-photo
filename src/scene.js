define(["src/cameraEngine","src/cameraControls","src/mustache","src/urlUtils"],function(e,t,n,r){var i=[{name:"Tree Bear",layers:[{name:"background",source:"content/treeDog/tree-dog-24-back-540.jpg",focalDistance:15},{name:"foreground",source:"content/treeDog/tree-dog-24-fore-540.png",focalDistance:1.3}],hdrToLdrMultiplier:1.8,sceneEV:9,EVOffset:3,width:540,height:360,focalLength:24,location:"Retiro Park, Madrid",description:"Poor little bear."},{name:"Tree Bear",layers:[{name:"background",source:"content/treeDog/tree-dog-50-back-540.jpg",focalDistance:15},{name:"foreground",source:"content/treeDog/tree-dog-50-fore-540.png",focalDistance:1.3}],hdrToLdrMultiplier:1.8,sceneEV:9,EVOffset:3,width:540,height:360,focalLength:50,location:"Retiro Park, Madrid",description:"If we zoom in while keeping the aperture constant, the background becomes more blurred."},{name:"Tree Bear",layers:[{name:"background",source:"content/treeDog/tree-dog-80-back-540.jpg",focalDistance:15},{name:"foreground",source:"content/treeDog/tree-dog-80-fore-540.png",focalDistance:1.3}],hdrToLdrMultiplier:1.2,sceneEV:9,EVOffset:0,width:540,height:360,focalLength:80,location:"Retiro Park, Madrid",description:"At 80mm we're in the telephoto range, and at a distance of only 1.3m from our subject we can acheive a very shallow depth of field effect by using a large aperture. Remember a larger aperture means lower f-stop.",notes:"With a very large aperture the tree in the foreground should start to become blurred, even when the dog is in focus, this shows a weakness of the simulation method, which simplifies the scene into only two layers"},{name:"Church",layers:[{name:"",source:"content/cathedral/cathedral-540.jpg",focalDistance:40}],hdrToLdrMultiplier:1.4,sceneEV:11,EVOffset:0,width:540,height:360,focalLength:35,description:"Taken while the sun was setting. At this focal range and distance the whole image stays in focus, even when using a large aperture."},{name:"Lounge",layers:[{name:"background",source:"content/loungeScene/lounge-hdr-background.jpg",focalDistance:8},{name:"foreground",source:"content/loungeScene/lounge-hdr-foreground.png",focalDistance:1.5}],hdrToLdrMultiplier:2,sceneEV:3,EVOffset:2.3,width:540,height:360,focalLength:50,description:"This is a low-light scene. The scene is static, so you can improve the quality by using a slower shutter speed."},{name:"Lounge, moving dog",layers:[{name:"background",source:"content/loungeScene/lounge-hdr-background.jpg",focalDistance:8},{name:"foreground",source:"content/loungeScene/lounge-hdr-foreground.png",focalDistance:1.5,horizontalMotionBlur:8}],hdrToLdrMultiplier:2,sceneEV:3,EVOffset:2.3,width:540,height:360,focalLength:50,description:"This is a low-light scene and the dog is moving on a conveyor belt just out of shot, so the shutter speed needs to be kept reasonably fast to avoid motion blur. This makes it impossible to get a sharp, low noise image with a typical compact camera and shows the advantage of having a camera with a large aperture."}],s,o,u,a,f,l,c,h,p,d,v=100,m=[],g,y=!0,b=function(e){console.log("loading image "+e),o++;var t=new Image;return t.onload=w,t.src=r.getResourceUrl(e),t},w=function(){console.log("image loaded"),o--,o===0&&E()},E=function(){$("#loading").hide(),$.each(a,function(e,t){N(t,e),N(t,e)}),c.width=s.width,c.height=s.height,g.focusLayer=s.layers.length-1,s.layers.length>1?$("input[name=focus][value=back]").attr("disabled",!1):($("input[name=focus][value=back]").attr("disabled",!0),$("input[name=focus][value=fore]").prop("checked",!0)),$("input[name=focus]:checked").change(),C(["scene"])},S=0,x=function(t,n,r){r=r||0,n=Math.abs(n);var i;n<1?i=.25:n<6?i=.5:i=1,n=Math.round(n/i)*i;var s="l:"+t+", "+"r:"+n;if(!(s in p)||r>0)p[s]=e.fastBlur(f[t],n+r,n),S++,console.log("cache miss, cache size: "+S);return p[s]},T=function(e){console.time("focus");var t=c.getContext("2d");$.each(f,function(n,r){var i,o,u,a=s.layers[Math.min(e.focusLayer,s.layers.length-1)].focalDistance;i=Math.abs(1/a-1/s.layers[n].focalDistance)/(e.aperture*e.cameraSpec.cropFactor)*s.focalLength*s.focalLength/160,o=s.layers[n].horizontalMotionBlur||0,console.log("hblur for layer "+n+" = "+o),u=x(n,i,o*e.shutter),t.drawImage(u,0,0)}),console.timeEnd("focus")},N=function(e,t){f[t]=document.createElement("canvas"),f[t].width=s.width,f[t].height=s.height,l[t]=f[t].getContext("2d"),l[t].drawImage(e,0,0)},C=function(e){m=m.concat(e);if(o>0){console.log("drawScene cancelled, still loading");return}clearTimeout(d),d=setTimeout(function(){var e=m;m=[],k(e)},Math.min(v,100))},k=function(n){if(n.indexOf("cameraSpec")>-1||n.indexOf("scene")>-1){console.log("cameraSpec changed"),g.supportsFocalLength(s.focalLength/g.cameraSpec.cropFactor)?$("#simulationStatus").text(""):$("#simulationStatus").text("Note: the selected camera/lens combination doesn't support this photo's focal length of "+s.focalLength+"mm (full frame equivalent)."),t.setup(g,C,s.focalLength/g.cameraSpec.cropFactor);return}var r=g.aperture;g.calculate(s.sceneEV,s.focalLength/g.cameraSpec.cropFactor),t.updateDisplay(),r!==g.aperture&&n.push("aperture"),console.log("f"+g.aperture+"  "+g.focus+"m  "+Math.floor(g.ISO)+"ISO   "+g.shutter+"s  "+g.cameraSpec.cropFactor+"x"),T(g);var i=c.getContext("2d"),o=(new Date).getTime();console.time("drawPhoto"),console.log("camera EV = "+g.EV()),e.drawPhoto(i.getImageData(0,0,s.width,s.height),h,s.sceneEV-g.EV()+s.EVOffset,g.cameraSpec.cropFactor*Math.sqrt(g.ISO)*256/600,s.hdrToLdrMultiplier),console.timeEnd("drawPhoto"),v=(new Date).getTime()-o},L=function(e,t){g=e,u=document.getElementById("largeCanvas"),c=document.createElement("canvas");if(!u||!u.getContext){O();return}h=u.getContext("2d");if(!h){O();return}var r=1;A(r),t.html(n.toHtml("sceneSelector",{scenes:i})),t.change(function(){var e=t.find("option").index(t.find("option:selected"));console.log("change scene: ",e),A(e)}),t.find("option").eq(r).prop("selected",!0)},A=function(e){o=0,a=[],f=[],l=[],p={},s=i[e],console.log("loading scene "+e+": "+s.name),$("#sceneInfo").html(n.toHtml("sceneInfo",s)),$("#loading").fadeIn(400),$.each(s.layers,function(e,t){a[e]=b(t.source)})},O=function(){CFInstall.check({mode:"overlay",destination:"http://bethecamera.com"})};return{init:L,drawScene:C,cache:function(){return p},getFocalLength:function(){return s.focalLength}}})