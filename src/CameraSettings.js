define(["src/exposureFunctions"],function(e){var t=function(e,t,n,r,i){this.mode=e||"Auto",this.ISO=t||800,this.aperture=n||2,this.shutter=r||1/16,this.EVComp=0,this.focusLayer=1,this.cameraSpec=i||this.DEFAULT_CAMERA_SPEC,this.error=""};return t.prototype.DEFAULT_CAMERA_SPEC={cropFactor:1,minISO:100,maxISO:6400,minAperture:32,minShutter:1/2048,maxShutter:2,lens:[{focalLength:24,maxAperture:4},{focalLength:105,maxAperture:4}]},t.prototype.maxApertureAtFocalLength=function(t){var n=this.cameraSpec.lens[0].focalLength,r=this.cameraSpec.lens[0].maxAperture,i=this.cameraSpec.lens[this.cameraSpec.lens.length-1].focalLength,s=this.cameraSpec.lens[this.cameraSpec.lens.length-1].maxAperture,o;return r===s?o=r:t<n?o=r:t>i?o=s:o=r+(s-r)*(t-n)/(i-n),console.log("max ap at "+t+"mm = "+o),e.roundAperture(o)},t.prototype.calculate=function(t,n){var r=this.cameraSpec.minISO||100,i=this.cameraSpec.maxISO||3200,s=this.cameraSpec.minAperture,o=this.maxApertureAtFocalLength(n),u=this.cameraSpec.minShutter,a=this.cameraSpec.maxShutter,f=t-this.EVComp;this.error="";switch(this.mode){case"A":break;case"Av":console.log("Av calculate"),s=this.aperture,o=this.aperture;break;case"Tv":u=this.shutter,a=this.shutter;break;case"M":this.EVComp=t-this.EV();return}var l=e.EV(r,s,u),c=e.EV(i,o,a);if(f<=c)this.ISO=i,this.aperture=o,this.shutter=a;else if(f>=l)this.ISO=r,this.aperture=s,this.shutter=u;else{var h=Math.min(Math.max(1/128,u),a),p=Math.min(Math.max(.5,u),a),d=Math.min(Math.max(400,r),i);console.log("target ISO = "+d),console.log("max ISO = "+i),console.log("target shutter = "+h);var v=e.EV(i,o,p),m=e.EV(d,o,h),g=e.EV(r,o,h),y=e.EV(r,o,u),b;if(f<=v)this.ISO=i,this.aperture=o,this.shutter=a/Math.pow(2,f-c);else if(f<=m)this.aperture=o,b=(m-f)/(m-v),console.log("fraction = "+b),this.ISO=e.thirdsToISO(b*e.ISOToThirds(i)+(1-b)*e.ISOToThirds(d)),this.shutter=e.thirdsToShutter(b*e.shutterToThirds(p)+(1-b)*e.shutterToThirds(h));else if(f<=g)this.aperture=o,this.shutter=h,b=(g-f)/(g-m),this.ISO=e.thirdsToISO(b*e.ISOToThirds(d)+(1-b)*e.ISOToThirds(r));else if(f<=y)this.aperture=o,this.ISO=r,b=(y-f)/(y-g),this.shutter=e.thirdsToShutter(b*e.shutterToThirds(h)+(1-b)*e.shutterToThirds(u));else{this.ISO=r,this.shutter=u;var b=(l-f)/(l-y);this.aperture=e.thirdsToAperture(b*e.apertureToThirds(o)+(1-b)*e.apertureToThirds(s))}}console.log("EV: "+this.EV()+" / "+f),e.roundEV(this.EV())>e.roundEV(f)?this.error="Scene too dark":e.roundEV(this.EV())<e.roundEV(f)&&(this.error="Scene too light")},t.prototype.EV=function(){return e.EV(this.ISO,this.aperture,this.shutter)},t.prototype.supportsFocalLength=function(e){console.log("checking focal length: "+e);var t=this.cameraSpec.lens[0].focalLength,n=this.cameraSpec.lens[this.cameraSpec.lens.length-1].focalLength;return e*.98<=n&&e*1.02>=t},t})