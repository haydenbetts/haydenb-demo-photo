define(["src/exposureFunctions"],function(e){var t=[],n=[],r=[],i=[],s=[],o,u,a,f,l,c,h,p=!0,d=function(i){$("#ISOAmount").val(c.ISO+" ISO"),$("#apertureAmount").val("f"+c.aperture),c.shutter<.5?$("#shutterAmount").val("1/"+Math.round(1/c.shutter)+" s"):$("#shutterAmount").val(Math.round(c.shutter*10)/10+" s");var l="";c.EVComp>0?l="+":c.EVComp<0&&(l="-"),$("#exposureAmount").val(l+Math.abs(Math.round(100*e.roundEV(c.EVComp))/100)),o.slider({value:t.indexOf(e.roundISO(c.ISO))}),u.slider({value:n.indexOf(e.roundAperture(c.aperture))}),a.slider({value:r.indexOf(e.roundShutter(c.shutter))});var h=Math.min(s[s.length-1],Math.max(s[0],e.roundEV(c.EVComp)));f.slider({value:s.indexOf(h)}),$("#simulationError").text(c.error)},v=function(e,n){c.ISO=t[n.value],d(),p||l(["ISO"])},m=function(e,t){c.aperture=n[t.value],d(),p||l(["aperture"])},g=function(e,t){c.shutter=r[t.value],d(),p||l(["shutter"])},y=function(e,t){c.EVComp=s[t.value],d(),p||l(["EVComp"])},b=function(){var e=$("input[name=focus]:checked").val();console.log("focus plane: "+e),$("label[data-focus]").removeClass("selected"),$("label[data-focus="+e+"]").addClass("selected"),e==="fore"?c.focusLayer=1:c.focusLayer=0,l(["focus"])},w=function(){var e=$("input[name=mode]:checked").val();$("label[data-mode]").removeClass("selected"),$("label[data-mode="+e+"]").addClass("selected"),console.log("Mode : "+e),c.mode=e,p||l(["aperture","ISO","shutter"]);switch(e){case"A":o.slider("disable"),u.slider("disable"),a.slider("disable"),f.slider("enable");break;case"Av":o.slider("disable"),u.slider("enable"),a.slider("disable"),f.slider("enable");break;case"Tv":o.slider("disable"),u.slider("disable"),a.slider("enable"),f.slider("enable");break;case"M":o.slider("enable"),u.slider("enable"),a.slider("enable"),f.slider("disable");break;default:console.log("Mode not recognised")}},E=function(e,t){var n=e.changedTouches,r=n[0],i="";switch(e.type){case"touchstart":i="mousedown";break;case"touchmove":i="mousemove";break;case"touchend":i="mouseup";break;default:return}var s=document.createEvent("MouseEvent");s.initMouseEvent(i,!0,!0,window,1,r.screenX,r.screenY,r.clientX,r.clientY,!1,!1,!1,!1,0,null),r.target.dispatchEvent(s),e.preventDefault()},S=function(i,h,d){c=i,l=h,o=$("#ISOSlider"),u=$("#apertureSlider"),a=$("#shutterSlider"),f=$("#exposureSlider"),console.log("cam spec = "+JSON.stringify(c.cameraSpec)),t=e.ISORange(c.cameraSpec.minISO,c.cameraSpec.maxISO),n=e.apertureRange(c.maxApertureAtFocalLength(d),c.cameraSpec.minAperture),r=e.shutterRange(c.cameraSpec.minShutter,c.cameraSpec.maxShutter),s=e.EVRange(-3,3),console.log("ap vals = "+JSON.stringify(n)),o.slider({value:t.indexOf(e.roundISO(c.ISO)),min:0,max:t.length-1,step:1,slide:v}),u.slider({value:n.indexOf(e.roundAperture(c.aperture)),min:0,max:n.length-1,step:1,slide:m}),a.slider({value:r.indexOf(e.roundShutter(c.shutter)),min:0,max:r.length-1,step:1,slide:g}),f.slider({value:s.indexOf(e.roundEV(c.EVComp)),min:0,max:s.length-1,step:1,slide:y}),$(".ui-slider-handle").each(function(e,t){t.addEventListener("touchstart",E,!0),t.addEventListener("touchmove",E,!0),t.addEventListener("touchend",E,!0),t.addEventListener("touchcancel",E,!0)}),p&&($("input[name=focus][value=fore]").prop("checked",!0),$("input[name=focus]").change(b),b(),$("input[name=mode][value=A]").prop("checked",!0),$("input[name=mode]").change(w),w()),x(),p=!1},x=function(){var e=c.ISO,i=c.aperture,s=c.shutter;c.ISO=Math.min(Math.max(c.ISO,t[0]),t[t.length-1]),c.aperture=Math.min(Math.max(c.aperture,n[0]),n[n.length-1]),c.shutter=Math.min(Math.max(c.shutter,r[0]),r[r.length-1]);var o=[];e!==c.ISO&&o.push("ISO"),i!==c.aperture&&o.push("aperture"),s!==c.shutter&&o.push("shutter"),d(),p||l(o.concat(["cropFactor"]))};return{setup:S,restrictSettings:x,updateDisplay:d}})